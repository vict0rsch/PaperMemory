let handleBackToFocus=e=>{let t=eventId(e);setTimeout(()=>{dispatch("memory-container--"+t,"focus")},250)},handleDeleteItem=e=>{e=eventId(e);showConfirmDeleteModal(e)},handleOpenItemLink=e=>{e=eventId(e);focusExistingOrCreateNewPaperTab(global.state.papers[e],!0)},handleOpenItemScirate=e=>{var e=eventId(e),t="https://scirate.com/arxiv/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewCodeTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemVanity=e=>{var e=eventId(e),t="https://www.arxiv-vanity.com/papers/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewCodeTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemAr5iv=e=>{var e=eventId(e),t="https://ar5iv.labs.arxiv.org/html/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewCodeTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemHuggingface=e=>{var e=eventId(e),t="https://huggingface.co/papers/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewCodeTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemCodeLink=async e=>{e=eventId(e),e=global.state.papers[e].codeLink;await focusExistingOrCreateNewCodeTab(e)},handleOpenItemWebsiteURL=async e=>{var e=eventId(e),t=global.state.papers[e].pdfLink;global.state.papers[e]=updatePaperVisits(global.state.papers[e]),await setStorage("papers",global.state.papers),await focusExistingOrCreateNewCodeTab(t)},handleCopyMarkdownLink=async e=>{var e=eventId(e),t=global.state.prefs,a=t.checkPreferPdf?"PDF":"Abstract",r=global.state.papers[e],r=makeMdLink(r,t);await copyAndConfirmMemoryItem(e,r,`Markdown ${a} link copied!`)},handleCopyBibtex=async e=>{var e=eventId(e),t=global.state.papers[e].bibtex,t=bibtexToObject(t);t.hasOwnProperty("url")||(t.url=paperToAbs(global.state.papers[e])),t.hasOwnProperty("pdf")||"website"===global.state.papers[e].source||(t.pdf=paperToPDF(global.state.papers[e])),await copyAndConfirmMemoryItem(e,bibtexToString(t),"Bibtex copied!")},handleCopyPDFLink=async e=>{var e=eventId(e),t=global.state.prefs,a=global.state.papers[e],a=(t.checkPreferPdf?paperToPDF:paperToAbs)(a),t=t.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem(e,a,t+" link copied!")},handleCopyHyperLink=async e=>{var e=eventId(e),t=global.state.prefs,a=global.state.papers[e],t=(t.checkPreferPdf?paperToPDF:paperToAbs)(a);await copyAndConfirmMemoryItem(e,t,"Hyperlink copied!",!1,a.title)},handleAddItemToFavorites=e=>{var e=eventId(e),t=hasClass("memory-container--"+e,"favorite");saveFavoriteItem(e,!t)},handleMemoryOpenLocal=e=>{var e=eventId(e),t=global.state.files[e],a=global.state.papers[e];global.state.papers[e]=updatePaperVisits(a),setStorage("papers",global.state.papers),t&&(t.id||0===t.id)&&chrome.downloads.open(t.id),window?.close&&window.close()},handleTextareaFocus=()=>{textareaFocusEnd(this)},handleMemorySaveEdits=e=>{var{note:t,codeLink:a}=getPaperEdits(e);saveNote(e,t),saveCodeLink(e,a),updatePaperTags(e,"memory-item-tags")},handleCancelPaperEdit=e=>{e.preventDefault();var e=eventId(e),t=global.state.papers[e];val(findEl(e,"form-note-textarea"),t.note),setHTML(findEl(e,"memory-item-tags"),getTagsOptions(t)),dispatch(findEl(e,"memory-item-edit"),"click")},handleTogglePaperEdit=e=>{e.preventDefault();var e=eventId(e),t=findEl("memory-container--"+e),a=findEl(e,"code-and-note"),r=findEl(e,"extended-item"),o=findEl(e,"tag-list"),s=findEl(e,"memory-authors"),i=findEl(e,"edit-tags"),l=findEl(e,"memory-item-actions");let n=$(findEl(e,"memory-item-tags"));hasClass(t,"expand-open")?(removeClass(t,"expand-open"),slideDown(a,150),slideDown(o,150),slideDown(l,150),slideDown(s,150),slideUp(r,150),slideUp(i,150),setTimeout(()=>{n.select2("destroy")},500)):(addClass(t,"expand-open"),n.select2({...global.select2Options,width:"86%"}),hasClass(t,"has-monitoring")||n.on("change",monitorPaperEdits(e,!1)),t.classList.add("has-monitoring"),slideUp(a,150),slideUp(o,150),slideUp(l,150),slideUp(s,150),slideDown(r,150),slideDown(i,150))},handleMemorySelectChange=e=>{e=e.target.value;global.state.sortKey=e,sortMemory(),displayMemoryTable(),setMemorySortArrow("down")},handleMemorySortArrow=e=>{"memory-sort-arrow-down"===querySelector("#memory-sort-arrow svg").id?setMemorySortArrow("up"):setMemorySortArrow("down"),reverseMemory(),displayMemoryTable()},handleFilterFavorites=()=>{var e=!global.state.showFavorites;(global.state.showFavorites=e)?(addClass(findEl("filter-favorites").querySelector("svg"),"favorite"),sortMemory(),global.state.papersList=global.state.papersList.filter(e=>e.favorite),displayMemoryTable(),setMemorySortArrow("down"),findEl("memory-select").innerHTML+='<option value="favoriteDate">Last favoured</option>',e=global.state.papersList.length,setPlaceholder("memory-search",`Search ${e} entries...`)):(removeClass(findEl("filter-favorites").querySelector("svg"),"favorite"),"favoriteDate"===val("memory-select")&&(val("memory-select","lastOpenDate"),global.state.sortKey="lastOpenDate"),querySelector('#memory-select option[value="favoriteDate"]').remove(),sortMemory(),setMemorySortArrow("down"),val("memory-search").trim()?dispatch("memory-search","keypress"):(global.state.papersList=global.state.sortedPapers,displayMemoryTable()),e=global.state.sortedPapers.length,setPlaceholder("memory-search",`Search ${e} entries...`))},handleMemorySearchKeyPress=a=>e=>{var t=val("memory-search").trim();if(log(t),t||setTimeout(()=>{style("memory-search-clear-icon","visibility","hidden")},0),!t){if(global.state.papersList.length!==global.state.sortedPapers.length)return global.state.papersList=global.state.sortedPapers,void displayMemoryTable();if(!a&&"Backspace"!==e.key)return}style("memory-search-clear-icon","visibility","visible"),(t.startsWith("t:")?searchMemoryByTags:t.startsWith("c:")?searchMemoryByCode:t.startsWith("y:")?searchMemoryByYear:searchMemory)(t),toggleTagsCollapse(t.startsWith("t:")),displayMemoryTable()},handleMemorySearchKeyUp=e=>{var t;"Backspace"==e.key&&((t=new Event("keypress")).key="Backspace",dispatch("memory-search",t)),"memory-search"===e.target.id&&dispatch("memory-search","keypress")},handleCancelModalClick=()=>{hideId("delete-paper-modal")},handleConfirmDeleteModalClick=async e=>{var t=findEl("delete-paper-modal-hidden-id").innerHTML,a=global.state.papers[t].title,r=global.state.papers[t].pdfLink;await deletePaperInStorage(t,global.state.papers),displayMemoryTable(),hideId("delete-paper-modal"),info(`Successfully deleted "${a}" (${t}) from PaperMemory`),global.state.currentId===t&&await updatePopupPaperNoMemory(r),setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),addListener("memory-switch","click",handleMemorySwitchClick)},handleTagClick=e=>{e=e.target.textContent;val("memory-search","t: "+e),dispatch("memory-search","keypress")},handleClearSearch=e=>{val("memory-search",""),dispatch("memory-search","clear-search"),style("memory-search-clear-icon","visibility","hidden")},handleMemorySwitchClick=()=>{(global.state.memoryIsOpen?closeMemory:openMemory)()},handlePopupKeydown=t=>{var a=t.key;if(!(["Backspace","Enter","Escape","a","e"].indexOf(a)<0))if(global.state.prefsIsOpen)"Escape"===a?(t.preventDefault(),closeMenu()):"Enter"===a&&querySelector("#menu-switch:focus")&&closeMenu();else if(global.state.memoryIsOpen){if("Enter"===a){if(querySelector("#filter-favorites:focus"))return void dispatch("filter-favorites","click");if(querySelector("#memory-sort-arrow:focus")&&"Enter"===a)return void dispatch("memory-sort-arrow","click")}let e;var r,o=querySelector(".memory-container:focus");if("Escape"!==a){if(!o)return;e=o.id.split("--")[1]}"Backspace"===a?dispatch(findEl(e,"memory-delete"),"click"):"Enter"===a?(r="website"===global.state.papers[e].source?findEl(e,"memory-website-url"):global.state.prefs.checkEnterLocalPdf&&findEl(e,"memory-item-openLocal")||findEl(e,"memory-item-link"),dispatch(r,"click")):"Escape"===a?(t.preventDefault(),o&&hasClass(o,"expand-open")?handleTogglePaperEdit(t):closeMemory()):"e"===a&&dispatch(findEl(e,"memory-item-edit"),"click")}else if("a"===a){if(queryAll(":focus").some(e=>["INPUT","TEXTAREA"].includes(e.tagName)))return;global.state.papers&&dispatch("memory-switch","click")}else"Enter"===a&&("memory-switch-open"===(r=querySelector(":focus")).id?dispatch("memory-switch","click"):"menu-switch"===r.id?(dispatch("menu-switch","click"),dispatch("menu-switch","blur")):hasClass(r,"memory-item-svg-div")&&dispatch(r,"click"))},handlePrefsCheckChange=async e=>{let t=e.target.id,a=findEl(t).checked;global.state&&global.state.prefs?(global.state.prefs[t]=a,setStorage("prefs",global.state.prefs,function(){log(`Settings saved for ${t} (${a})`)})):((e=await getStorage("prefs")??{})[t]=a,setStorage("prefs",e,function(){log(`Settings saved for ${t} (${a})`)})),a&&"checkNoAuto"===t&&chrome.commands.getAll(e=>{e=e.find(e=>"manualParsing"===e.name).shortcut;console.log("shortcut: ",e),e||showPopupModal("manualParsing")})},handlePopupSaveEdits=e=>{var{note:t,codeLink:a,favorite:r}=getPaperEdits(e,!0);updatePaperTags(e,"#popup-item-tags--"+e),saveNote(e,t),saveCodeLink(e,a),saveFavoriteItem(e,r)},handlePopupDeletePaper=e=>()=>{showConfirmDeleteModal(e)},showTitleTooltip=(e,t)=>{t=t?findEl("popup-title-tooltip"):findEl(e,".title-tooltip");style(t,"display","block")},hideTitleTooltip=(e,t)=>{t=t?findEl("popup-title-tooltip"):findEl(e,".title-tooltip");style(t,"display","none")},getHandleTitleTooltip=(r,o,s)=>e=>{let t=s?global.state.currentId:eventId(e);var a=global.state.timerIdMap.get(e.target)??0;clearTimeout(a),a=setTimeout(()=>r(t,s),o),global.state.timerIdMap.set(e.target,a)},handleExpandAuthors=e=>{var e=eventId(e),t=findEl(e,"memory-authors");setHTML(t,cutAuthors(global.state.papers[e].author,1e5))},getPaperInfoTable=e=>{var t=[["Added",new Date(e.addDate).toLocaleString().replace(",","")],["Last open",new Date(e.lastOpenDate).toLocaleString().replace(",","")],["Visits",e.count],["Source",global.knownPaperPages[e.source].name]];return e.venue&&t.push(["Publication",`<strong>${e.venue} ${e.year}</strong>`]),`
        <table class="paper-info-table">
            ${t.map(e=>`
                        <tr>
                            <td><div class="info-table-key">${e[0]}</div></td>
                            <td><div class="info-table-value">${e[1]}</div></td>
                        </tr>
                    `).join("")}
        </table>
    `},getMemoryItemHTML=e=>{var t=getDisplayId(e.id),a=e.note||"",r=e.id,o=new Set(e.tags),s=getTagsOptions(e),i=e.favorite?"favorite":"",l={...global.svgActionsHoverTitles},n=(l.pdfLink="Open tab to "+e.title,l.copyLink="Copy URL to the paper's "+(global.state.prefs.checkPreferPdf?"PDF":"abstract"),`
        <small class="memory-item-faded">

            <div class="memory-code-link"> ${e.codeLink.replace(/^https?:\/\//,"")||""} </div>
            <div class="memory-website-url">
                ${"website"==e.source&&e.pdfLink.replace(/^https?:\/\//,"")||""}
            </div>
        </small>
    `);let d='<div class="memory-note-div memory-item-faded"></div>';e.note&&(d=`
            <div class="memory-note-div memory-item-faded">
                <span class="note-content-header">Note:</span>
                <span class="note-content">${a}</span>
            </div>
        `);var p=global.state.files.hasOwnProperty(e.id)?`
            <div
                class="memory-item-openLocal memory-item-svg-div"
                title='${l.openLocal}'
            >
                ${tablerSvg("vocabulary","",["memory-icon-svg"])}
            </div>`:"",c="website"===e.source?"":`
            <div
                class="memory-item-link memory-item-svg-div"
                title='${l.pdfLink}'
            >
                ${tablerSvg("external-link","",["memory-icon-svg"])}
            </div>`;let m="",g=(global.state.prefs.checkScirate&&"arxiv"===e.source&&(m=`
        <div
            class="memory-item-scirate memory-item-svg-div"
            title="Open on SciRate"
        >
            ${tablerSvg("messages","",["memory-icon-svg"])}
        </div>`),""),v=(global.state.prefs.checkVanity&&"arxiv"===e.source&&(g=`
        <div
            class="memory-item-vanity memory-item-svg-div"
            title="Open on Vanity"
        >
            ${tablerSvg("vanity","",["memory-icon-svg"])}
        </div>`),""),y=(global.state.prefs.checkAr5iv&&"arxiv"===e.source&&(v=`
        <div
            class="memory-item-ar5iv memory-item-svg-div"
            title="Open on ar5iv"
        >
            ${tablerSvg("ar5iv","",["memory-icon-svg"])}
        </div>`),"");global.state.prefs.checkHuggingface&&"arxiv"===e.source&&(y=`
        <div
            class="memory-item-huggingface memory-item-svg-div"
            title="Open on HuggingFace Papers"
        >
            ${tablerSvg("huggingface","",["memory-icon-svg"])}
        </div>`);var h=getPaperInfoTable(e);return`
        <div
            class="memory-container ${i}"
            tabindex="0"
            id="memory-container--${r}"
        >
            <h4 class="memory-title">
                <span class="memory-item-favorite">
                    ${tablerSvg("star","",["memory-item-favorite-svg",i])}
                </span>
                ${e.title}
                <div class="title-tooltip" style="display: none;">
                    ${h}
                </div>
            </h4>
            <div class="my-1 mx-0">
                <small class="tag-list">
                    ${[...o].map(e=>`<span class="memory-tag" >${e}</span>`).join("")}
                </small>
                <div class="edit-tags p-0" style="display: none">
                    <div class="flex-center-between">
                        <span class="label">Tags:</span>
                        <select
                            class="memory-item-tags"
                            id="memory-item-tags--${r}"
                            multiple="multiple"
                        >
                            ${s}
                        </select>
                    </div>
                </div>
            </div>
            <small class="memory-authors">${cutAuthors(e.author)}</small>

            <div class="code-and-note">${n} ${d}</div>

            <div class="memory-item-actions flex-center-between mt-2">
                <div class="d-flex align-items-center">
                    <div
                        class="memory-item-edit memory-item-svg-div me-2"
                        title='${l.edit}'
                    >
                        ${tablerSvg("writing","",["memory-icon-svg"])}
                    </div>

                    <small class="memory-item-faded memory-display-id">
                        ${t}
                    </small>
                </div>

                ${p}
                ${c}
                ${y}
                ${m}
                ${g}
                ${v}


                <div
                    class="memory-item-copy-link memory-item-svg-div"
                    title='${l.copyLink}'
                >
                    ${tablerSvg("link","",["memory-icon-svg"])}
                </div>

                <div
                    class="memory-item-copy-hyperlink memory-item-svg-div"
                    title='${l.copyHypeLink}'
                >
                    ${tablerSvg("device-desktop-code","",["memory-icon-svg"])}
                </div>



                <div class="memory-item-md memory-item-svg-div" title='${l.copyMd}'>
                    ${tablerSvg("markdown","",["memory-icon-svg"])}
                </div>

                <div
                    class="memory-item-bibtex memory-item-svg-div"
                    title='${l.copyBibtext}'
                >
                    ${tablerSvg("math-function","",["memory-icon-svg"])}
                </div>

                <span style="display: none" class="memory-item-feedback"></span>

            </div>

            <div class="extended-item" style="display: none">
                <div class="item-note">
                    <form class="form-note">
                        <div class="flex-center-start">
                            <span class="label">Code:</span>
                            <input
                                type="text"
                                class="form-code-input"
                                value="${e.codeLink||""}"
                                placeholder="Add link"
                            />
                        </div>
                        <div class="flex-center-start">
                            <span class="label">Note:</span>
                            <textarea
                                rows="2"
                                class="form-note-textarea"
                                placeholder="Anything to note?"
                            >
${a}</textarea
                            >
                        </div>
                        <div class="form-note-buttons">
                            <button class="cancel-note-form back-to-focus">
                                Done
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="memory-delete" title="Delete from Memory">-</div>
        </div>
    `},getPopupEditFormHTML=e=>{var t=e.id,a=getTagsOptions(e),r=e.note||"",o=getDisplayId(e.id);return` <div
        style="max-width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 4px 16px;"
    >
        <div style="width: 100%">
            <div
                style="width: 100%; display: flex; justify-content: space-between; align-items: center;"
            >
                <span class="label">Tags:</span>
                <select
                    id="popup-item-tags--${t}"
                    class="memory-item-tags"
                    multiple="multiple"
                >
                    ${a}
                </select>
            </div>
            <div
                class="form-note"
                id="popup-form-note--${t}"
                style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; flex-direction: column;"
            >
                <div class="flex-center-start w-100 mr-0">
                    <span class="label">Code:</span>
                    <input
                        id="popup-form-codeLink--${t}"
                        type="text"
                        class="form-code-input mt-0"
                        value="${e.codeLink||""}"
                        placeholder="Add code link"
                    />
                </div>
                <div class="flex-center-start w-100 mr-0">
                    <span class="label">Note:</span>
                    <textarea
                        rows="2"
                        class="popup-form-note-textarea"
                        id="popup-form-note-textarea--${t}"
                        placeholder="Anything to note?"
                    >
${r}</textarea
                    >
                </div>
            </div>
            <div
                style="display: flex; justify-content: space-between; align-items: center"
            >
                <div
                    style="display: flex; justify-content: flex-start; align-items: center"
                >
                    <label class="label" for="checkFavorite">Favorite: </label>
                    <input
                        ${""}
                        class="switch"
                        type="checkbox"
                        id="checkFavorite--${t}"
                        name="checkFavorite"
                        value="checkFavorite"
                    />
                </div>
                <div id="popup-delete-paper" title="Delete paper from Memory">
                    <svg
                        width="25"
                        height="25"
                        viewBox="0 0 24 24"
                        stroke-width="1"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke="white"
                    >
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <line x1="4" y1="7" x2="20" y2="7" />
                        <line x1="10" y1="11" x2="10" y2="17" />
                        <line x1="14" y1="11" x2="14" y2="17" />
                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                    </svg>
                </div>
                <small id="popup-displayId"> ${o} </small>
                <button
                    hidden
                    class="back-to-focus"
                    id="popup-save-edits--${t}"
                >
                    Save
                </button>
            </div>
        </div>
    </div>`},getPopupPaperIconsHTML=(e,t,a)=>{var r=e.id,t=isPdfUrl(t)?"HTML":"PDF";let o="",s=(global.state.prefs.checkScirate&&"arxiv"===e.source&&(o=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-scirate--${r}"
            title="Open on SciRate"
        >
            ${tablerSvg("messages","",["popup-click-svg"])}
        </div>`),""),i=(global.state.prefs.checkVanity&&"arxiv"===e.source&&(s=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-vanity--${r}"
            title="Open on Vanity"
        >
            ${tablerSvg("vanity","",["popup-click-svg"])}
        </div>`),""),l=(global.state.prefs.checkAr5iv&&"arxiv"===e.source&&(i=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-ar5iv--${r}"
            title="Open on ar5iv"
        >
            ${tablerSvg("ar5iv","",["popup-click-svg"])}
        </div>`),"");global.state.prefs.checkHuggingface&&"arxiv"===e.source&&(l=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-huggingface--${r}"
            title="Open on HuggingFace Papers"
        >
            ${tablerSvg("huggingface","",["popup-click-svg"])}
        </div>`);a=global.state.prefs.checkStore&&(a.localFile||a.stored||global.state.files.hasOwnProperty(e.id))?`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-openLocal--${r}"
            title="Open downloaded pdf"
        >
            ${tablerSvg("vocabulary","",["popup-click-svg"])}
        </div>
        `:`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-download--${r}"
            title="Download pdf"
        >
            ${tablerSvg("file-download","",["popup-click-svg"])}
        </div>
    `;return`
        ${"website"===e.source?"":`<div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-link--${r}"
            title="Open Paper ${t} Page"
        >
            ${tablerSvg("external-link","",["popup-click-svg"])}
        </div>`}
        ${l}
        ${o}
        ${s} ${i}
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-copy-link--${r}"
            title="Copy link to paper"
        >
            ${tablerSvg("link","",["popup-click-svg"])}
        </div>
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-copy-hyperlink--${r}"
            title="Copy hyperlink to paper"
        >
            ${tablerSvg("device-desktop-code","",["popup-click-svg"])}
        </div>

        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-md--${r}"
            title="Copy Markdown-formatted link"
        >
            ${tablerSvg("markdown","",["popup-click-svg"])}
        </div>

        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-bibtex--${r}"
            title="Copy Bibtex citation"
        >
            ${tablerSvg("math-function","",["popup-click-svg"])}
        </div>

        `+a},getTagsOptions=e=>{let r=new Set(e.tags);return[...global.state.paperTags].sort().map((e,t)=>{let a='<option value="'+e+'"';return r.has(e)&&(a+=' selected="selected" '),a+`>${e}</option>`}).join("")},toggleTagsCollapse=e=>{e?findEl("tags-list-container")||(e=`
            <div id="tags-list-container">
                <details id="tags-list-details" style="outline: none !important;">
                    <summary style="font-size: 0.85rem; color: #5f5f5f;">Tags list</summary>
                    ${`
            <ul id="all-tags-list">
                ${[...global.state.paperTags].map(e=>`<li class="memory-tag" >${e}</li>`).join("")}
            </ul>`}
                </details>
            </div>`,findEl("memory-filters").insertAdjacentHTML("afterend",e)):findEl("tags-list-container")?.remove()},updateAllMemoryPaperTagOptions=()=>{for(var e in global.state.papers){var t;global.state.papers.hasOwnProperty(e)&&"__dataVersion"!==e&&(t=global.state.papers[e],setHTML("memory-item-tags--"+e,getTagsOptions(t)))}},sampleAsciiArt=async()=>{var e=chrome.runtime.getURL("src/data/art.json"),e=await fetch(e).then(e=>e.json()),t=Object.keys(e).length,t=Math.floor(Math.random()*t),[e,t]=Object.entries(e)[t];return{animal:e,ascii:t}},updatePopupPaperNoMemory=async r=>{var{animal:e,ascii:t}=await sampleAsciiArt();let a=`
        <div class="no-paper-div">
            <h3>This paper is not in your Memory&nbsp;
            <span id="no-paper-why-span">
                <button class="code-font" id="no-paper-why-code">?</button>
            </span>
            </h3>
            <div>
                <div>Here's a ${e} for your trouble</div><br>
                <div id="ascii-art-div"><div style="text-align:">${t}</div></div>
            </div>
        </div>
    `;e=-1<navigator.userAgent.search("Firefox")||global.state.prefs.checkNoAuto;e&&(a+=`
            <div id="manual-trigger-wrapper">
                <div id="manual-trigger-btn">Try manual trigger</div>
                <div id="manual-loader-container" class="pm-container" style='display: none;'>
                    <div class="sk-folding-cube">
                        <div class="sk-cube1 sk-cube"></div>
                        <div class="sk-cube2 sk-cube"></div>
                        <div class="sk-cube4 sk-cube"></div>
                        <div class="sk-cube3 sk-cube"></div>
                    </div>
                </div>
                <div id="manual-parsing-error"></div>
            </div>
        `);let o=findEl("isArxiv").innerHTML;setHTML("isArxiv",a),addListener("no-paper-why-code","click",()=>{showPopupModal("noPaper")}),e&&addListener("manual-trigger-btn","click",async()=>{showId("manual-loader-container");try{var t=await isPaper(r);let e;var a=await addOrUpdatePaper({url:r,is:t});a&&(e=a.paper)&&(hideId("manual-loader-container"),setHTML("isArxiv",o),popupMain(r,t,!0))}catch(e){hideId("manual-loader-container"),setHTML("manual-parsing-error",`<strong>${"There was an issue parsing this paper. <br/> Raise an issue on Github if you think it is a bug.<br/>Attempted url: "+r}</strong>`),warn("Manual Parsing Error:",e)}})},showConfirmDeleteModal=e=>{var t=global.state.papers[e].title;setTextId("delete-modal-title",t),setHTML("delete-paper-modal-hidden-id",e),showId("delete-paper-modal","flex")},copyAndConfirmMemoryItem=async(e,t,a,r,o)=>{o?await copyHyperLinkToClipboard(t,o):copyTextToClipboard(t);let s=r?findEl("popup-feedback-copied"):findEl(e,"memory-item-feedback");s&&(s.innerText=a,fadeIn(s),setTimeout(()=>{fadeOut(s)},2e3))},focusExistingOrCreateNewCodeTab=t=>new Promise(o=>{(t=t.replace("http://","https://")).startsWith("https://")||(t="https://"+t);var e=new URL(t).origin;chrome.tabs.query({url:e+"/*"},e=>{for(let r of e)if(r.url.includes(t)){let t={active:!0},a={focused:!0};return chrome.windows.getCurrent(e=>{e.id!==r.windowId?chrome.windows.update(r.windowId,a,()=>{chrome.tabs.update(r.id,t),o()}):(chrome.tabs.update(r.id,t),o())}),void o()}chrome.tabs.create({url:t}),o()}),o()}),focusExistingOrCreateNewPaperTab=(i,l)=>{chrome.tabs.query({},async e=>{var t,a=global.state.prefs,r=[];for(t of e){let e;try{e=t.url&&await parseIdFromUrl(t.url)}catch(e){}e&&e===i.id&&r.push(t)}let o;var s,e=a.checkPreferPdf?r.filter(e=>e.url&&isPdfUrl(e.url)):r.filter(e=>e.url&&!isPdfUrl(e.url));0<e.length?(s=l&&global.state.files.hasOwnProperty(i.id)?[]:r.filter(e=>e.url.startsWith("file://")),o=(0<s.length?s:e)[0]):0<r.length&&(o=r[0]),o?chrome.windows.getCurrent(e=>{e.id!==o.windowId?chrome.windows.update(o.windowId,{focused:!0},()=>{chrome.tabs.update(o.id,{active:!0})}):chrome.tabs.update(o.id,{active:!0})}):global.state.files.hasOwnProperty(i.id)&&!l?chrome.downloads.open(global.state.files[i.id].id):chrome.tabs.create({url:(a.checkPreferPdf?paperToPDF:paperToAbs)(i)}),global.state.papers[i.id]=updatePaperVisits(global.state.papers[i.id]),chrome.storage.local.set({papers:global.state.papers})})},saveNote=(t,a)=>{global.state.papers[t].note=a,chrome.storage.local.set({papers:global.state.papers},()=>{setHTML(findEl(t,"memory-note-div"),a?` <div class="memory-note-div memory-item-faded">
                      <span class="note-content-header">Note:</span>
                      <span class="note-content">${a}</span>
                  </div>`:'<div class="memory-note-div memory-item-faded"></div>');var e=findEl("popup-form-note-textarea--"+t);val(e,a),val(findEl(t,"form-note-textarea"),a)})},saveCodeLink=(t,a)=>{a=a.trim(),global.state.papers[t].codeLink=a,chrome.storage.local.set({papers:global.state.papers},()=>{var e=a.replace(/^https?:\/\//,""),e=(setHTML(findEl(t,"memory-code-link"),e),setHTML("popup-code-link",e),val(findEl(t,"form-code-input"),a),(a?showId:hideId)("popup-code-link"),findEl("popup-form-codeLink--"+t));val(e,a)})},saveFavoriteItem=(a,r)=>{global.state.papers[a].favorite=r,global.state.papers[a].favoriteDate=(new Date).toJSON(),chrome.storage.local.set({papers:global.state.papers},()=>{(r?(addClass("memory-container--"+a,"favorite"),addClass):(removeClass("memory-container--"+a,"favorite"),removeClass))(findEl(a,"memory-item-favorite").querySelector("svg"),"favorite"),"favoriteDate"===global.state.sortKey&&(r||(sortMemory(),displayMemoryTable()),e=global.state.sortedPapers.filter(e=>e.favorite).length,t=findEl("memory-search"))&&setPlaceholder(t,`Search ${e} entries`);var e,t=findEl("checkFavorite--"+a);t&&(t.checked=r)})},setMemorySortArrow=e=>{let t;t="up"===e?`<svg
            viewBox="0 0 24 24"
            class="memory-sort-arrow-svg"
            id="memory-sort-arrow-up"
        >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="16" y1="9" x2="12" y2="5" />
            <line x1="8" y1="9" x2="12" y2="5" />
        </svg>`:`<svg
            class="memory-sort-arrow-svg"
            id="memory-sort-arrow-down"
            viewBox="0 0 24 24"
        >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="16" y1="15" x2="12" y2="19" />
            <line x1="8" y1="15" x2="12" y2="19" />
        </svg>`,setHTML("memory-sort-arrow",t)},reverseMemory=()=>{global.state.sortedPapers.reverse(),global.state.papersList.reverse()},searchMemory=e=>{var l,n=e.toLowerCase().split(" "),d=[];for(l of global.state.sortedPapers){let t=l.title.toLowerCase(),a=l.author.toLowerCase(),r=l.note.toLowerCase(),o=l.tags.join(" ").toLowerCase(),s=getDisplayId(l.id).toLowerCase(),i=l.venue?.toLowerCase()||"";!n.every(e=>t.includes(e)||a.includes(e)||r.includes(e)||o.includes(e)||s.includes(e)||i.includes(e))||global.state.showFavorites&&!l.favorite||d.push(l)}global.state.papersList=d},searchMemoryByYear=e=>{var a,t=e.includes("<")?"smaller":e.includes(">")?"greater":"",r=e.replace("y:","").replace(/(<|>)/g,"").toLowerCase().replaceAll(","," ").split(" ").filter(e=>0<e.length).map(e=>4===e.length?e:"20"+e).map(e=>parseInt(e,10)),o=(console.log("searchYears: ",r),[]);let s=(e,t)=>e===t;"smaller"==t?s=(e,t)=>t<e:"greater"==t&&(s=(e,t)=>e<t);for(a of global.state.sortedPapers){let t=parseInt(a.year,10);r.some(e=>s(e,t))&&o.push(a)}global.state.papersList=o},searchMemoryByTags=e=>{var t,a=e.replace("t:","").toLowerCase().split(" "),r=[];for(t of global.state.sortedPapers){let e=t.tags.map(e=>e.toLowerCase());!a.every(t=>e.some(e=>0<=e.indexOf(t)))||global.state.showFavorites&&!t.favorite||r.push(t)}global.state.papersList=r},searchMemoryByCode=e=>{var a,r=e.replace("c:","").toLowerCase().split(" "),o=[];for(a of global.state.sortedPapers){let t=a.codeLink||"";t=t.toLowerCase(),!r.every(e=>t.includes(e))||global.state.showFavorites&&!a.favorite||o.push(a)}global.state.papersList=o},updatePaperTagsHTML=e=>{setHTML(findEl(e,"tag-list"),global.state.papers[e].tags.map(e=>`<span class="memory-tag">${e}</span>`).join(""))},updateTagOptions=e=>{updateAllMemoryPaperTagOptions();var t=getTagsOptions(global.state.papers[e]);setHTML("popup-item-tags--"+e,t)},updatePaperTags=(t,e)=>{let a;a=e.startsWith("#")?findEl(e.replace("#","")):findEl(t,e);e=parseTags(a);let r=!1;new Set;arraysIdentical(global.state.papers[t].tags,e)||(r=!0),global.state.papers[t].tags=e,r&&chrome.storage.local.set({papers:global.state.papers},()=>{var e;makeTags(),updateTagOptions(t),updatePaperTagsHTML(t);for(e of queryAll(".memory-tag",findEl(t,"tag-list")))addListener(e,"click",handleTagClick)})},displayOnScroll=r=>delay(()=>{var e=findEl("memory-table").getBoundingClientRect().bottom,t=r?findEl("memory-container").getBoundingClientRect().height:window.innerHeight,a=global.state.currentMemoryPagination*global.state.memoryItemsPerPage;Math.abs(e-t)<t&&a<global.state.papersList.length&&(global.state.currentMemoryPagination+=1,displayMemoryTable(global.state.currentMemoryPagination))},50),displayMemoryTable=(e=0)=>{var t,a=Date.now(),r=findEl("memory-table"),o=(0===e&&(setHTML(r,""),global.state.currentMemoryPagination=0),[]);for(t of global.state.papersList.slice(e*global.state.memoryItemsPerPage,(e+1)*global.state.memoryItemsPerPage))try{o.push(getMemoryItemHTML(t))}catch(e){log("displayMemoryTable error:"),log(e),log(t)}0===e?setHTML(r,o.join("")):r.insertAdjacentHTML("beforeend",o.join("")),addEventToClass(".back-to-focus","click",handleBackToFocus),addEventToClass(".memory-delete","click",handleDeleteItem),addEventToClass(".memory-item-link","click",handleOpenItemLink),addEventToClass(".memory-item-scirate","click",handleOpenItemScirate),addEventToClass(".memory-item-vanity","click",handleOpenItemVanity),addEventToClass(".memory-item-ar5iv","click",handleOpenItemAr5iv),addEventToClass(".memory-item-huggingface","click",handleOpenItemHuggingface),addEventToClass(".memory-code-link","click",handleOpenItemCodeLink),addEventToClass(".memory-website-url","click",handleOpenItemWebsiteURL),addEventToClass(".memory-item-md","click",handleCopyMarkdownLink),addEventToClass(".memory-item-bibtex","click",handleCopyBibtex),addEventToClass(".memory-item-copy-link","click",handleCopyPDFLink),addEventToClass(".memory-item-copy-hyperlink","click",handleCopyHyperLink),addEventToClass(".memory-item-openLocal","click",handleMemoryOpenLocal),addEventToClass(".memory-item-favorite","click",handleAddItemToFavorites),addEventToClass(".cancel-note-form","click",handleCancelPaperEdit),addEventToClass(".memory-item-edit","click",handleTogglePaperEdit),addEventToClass(".memory-tag","click",handleTagClick),setFormChangeListener(void 0,!1),addEventToClass(".memory-title","mouseenter",getHandleTitleTooltip(showTitleTooltip,1500)),addEventToClass(".memory-title","mouseleave",getHandleTitleTooltip(hideTitleTooltip,500)),addEventToClass(".expand-memory-authors","click",handleExpandAuthors),addEventToClass(".form-note-textarea","focus",handleTextareaFocus);e=Date.now();info("Display duration (s): "+(e-a)/1e3)},makeMemoryHTML=async()=>{setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),displayMemoryTable();let e=300;global.state.papersList.length<20?e=0:global.state.papersList.length<100&&(e=150),addListener("memory-search","keypress",delay(handleMemorySearchKeyPress(),e)),addListener("memory-search","clear-search",handleMemorySearchKeyPress(!0)),addListener("memory-search","keyup",handleMemorySearchKeyUp),addListener("delete-paper-modal-cancel-button","click",handleCancelModalClick),addListener("delete-paper-modal-confirm-button","click",handleConfirmDeleteModalClick),addListener("filter-favorites","click",handleFilterFavorites),addListener("memory-select","change",handleMemorySelectChange),addListener("memory-sort-arrow","click",handleMemorySortArrow),addListener("memory-container","scroll",displayOnScroll(!0))},openMemory=()=>{global.state.prefsIsOpen&&closeMenu(),global.state.memoryIsOpen=!0,hideId("memory-switch-open"),showId("memory-switch-close"),hideId("menu-switch"),dispatch("memory-switch","blur"),slideDown("memory-container",200,()=>{setTimeout(()=>{dispatch("memory-search","focus")},100)}),setTimeout(()=>{addListener("memory-search-clear-icon","click",handleClearSearch),val("memory-select","lastOpenDate"),setMemorySortArrow("down")},200)},closeMemory=()=>{dispatch("memory-switch","blur"),hideId("memory-switch-close"),showId("memory-switch-open"),slideUp("memory-container",200,()=>{val("memory-search",""),dispatch("memory-search","clear-search"),global.state.memoryIsOpen=!1,global.state.showFavorites&&dispatch("filter-favorites","click"),showId("menu-switch","flex")})},closeMenu=()=>{slideUp("menu-container",300),setHTML("menu-switch",tablerSvg("settings","menu-switch-svg",["pm-tabler-icon","menu-svg"])),dispatch("menu-switch","blur"),global.state.prefsIsOpen=!1},openMenu=()=>{slideDown("menu-container",300),dispatch("menu-switch","blur"),setHTML("menu-switch",tablerSvg("circle-x","close-menu-btn",["pm-tabler-icon","menu-svg"])),global.state.prefsIsOpen=!0},getAndTrackPopupMenuChecks=(e,t)=>{var a,r,o={};for(a of t){o[a]=e.hasOwnProperty(a)?e[a]:!(0<=global.prefsCheckDefaultFalse.indexOf(a));var s=findEl(a);s&&(s.checked=o[a])}setStorage("prefs",o);for(r of t)addListener(r,"change",handlePrefsCheckChange)},showPopupModal=e=>{queryAll(".popup-modal-content").forEach(hideId),showId(`modal-${e}-content`,"contents"),style("popup-modal-wrapper","display","flex"),[...document.getElementsByTagName("a")].forEach(e=>{addListener(e,"click",()=>{chrome.tabs.create({url:e.getAttribute("href")})})})},closePopupModal=()=>{style("popup-modal-wrapper","display","none")},setStandardPopupClicks=()=>{queryAll(".link-in-new-tab").forEach(e=>{addListener(e,"click",()=>{chrome.tabs.create({url:e.getAttribute("href")})})}),addListener("whats-new-container","click",()=>{chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;(e=void 0===e?{}:e).hasOwnProperty(t)||hideId("whats-new-marker"),chrome.storage.local.set({whatsnew:{...e,[t]:!0}}),showPopupModal("whatsnew")})}),addListener("keyboardShortcuts","click",()=>{showPopupModal("keyboard")}),addListener("keyboardShortcutsMenu","click",()=>{showPopupModal("keyboard")}),shouldWarn("pdf-title",e=>{e&&(showId("warning-button"),addListener("warning-button","click",async()=>{showPopupModal("warning-pdf-title");var e=await getStorage("userWarnings")??{};e["pdf-title"]=!0,setStorage("userWarnings",e),hideId("warning-button")}))}),addListener("close-popup-modal","click",closePopupModal),addListener(window,"click",e=>{e.target===findEl("popup-modal-wrapper")&&closePopupModal()}),addListener("menu-switch","click",()=>{(global.state.prefsIsOpen?closeMenu:openMenu)()}),addListener("memory-switch","click",handleMemorySwitchClick)},editManualWebsite=(p,c)=>{hideId("manual-website-validation"),showPopupModal("manual-website"),showId("website-trigger-btn");var e;for(e of["author","title","year","url","note","pdfLink"])findEl("manual-website-"+e).value=p[e]??"";setHTML("manual-website-url",p.codeLink),addListener("manual-website-form","submit",async e=>{e.preventDefault(),hideId("manual-website-validation");e=val("manual-website-title");let t=val("manual-website-author");var a,r=val("manual-website-year"),o=val("manual-website-note"),s=val("manual-website-pdfLink"),o=(t.includes(",")&&(t=t.split(",").map(e=>e.trim()).join(" and ")),{...p,title:e,author:t,year:r,note:o,pdfLink:s}),i=""+miniHash(t.split(" and ")[0].split(" ").last())+r+firstNonStopLowercase(e),{warnings:l,paper:r}=(o.bibtex=bibtexToString({...bibtexToObject(o.bibtex),author:t,year:r,title:e,citationKey:i,url:s}),validatePaper(o));let n="";for(a of Object.keys(l))for(var d of l[a])n+=`<li>${d}</li>`;return 0<n.length?(n=`<ul>${n}</ul>`,setHTML("manual-website-validation",n),showId("manual-website-validation")):(global.state.papers[r.id]=r,await setStorage("papers",global.state.papers),await pushToRemote(),popupMain(c,await isPaper(c),!0,null),hideId("website-trigger-btn"),hideId("notArxiv"),closePopupModal()),!1})},popupMain=async(o,t,s=!1,a=null)=>{console.log(navigator.userAgent),"PuppeteerAgent"===navigator.userAgent&&info("Is puppet"),addListener(document,"keydown",handlePopupKeydown),chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;e&&e.hasOwnProperty(t)||showId("whats-new-marker")}),console.log("manualTrigger: ",s),(s?(hideId("memory-switch"),showId("memory-spinner"),await initSyncAndState({forceInit:!0}),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML):setStandardPopupClicks)();let i=await getPrefs();if(getAndTrackPopupMenuChecks(i,global.prefsCheckNames),addListener("advanced-configuration","click",()=>{chrome.runtime.openOptionsPage()}),addListener("full-memory","click",()=>{chrome.tabs.create({url:chrome.runtime.getURL("src/fullMemory/fullMemory.html")})}),addListener("bib-matcher","click",()=>{chrome.tabs.create({url:chrome.runtime.getURL("src/bibMatcher/bibMatcher.html")})}),Object.values(t).some(e=>e)){setTimeout(()=>{document.body.style.height="auto",document.body.style.minHeight="450px"},0),showId("isArxiv","flex");let r=await parseIdFromUrl(o);if((global.state.currentId=r)&&global.state.papers.hasOwnProperty(r)){let a=global.state.papers[r];var l,s=a.id.replaceAll(".","\\.");setHTML("popup-paper-title",a.title.replaceAll("\n","")+'<div id="popup-title-tooltip" style="display: none;">'),setTextId("popup-authors",cutAuthors(a.author,350).replace(/({|})/g,"")),a.codeLink&&(setTextId("popup-code-link",a.codeLink.replace(/^https?:\/\//,"")),showId("popup-code-link")),"website"===a.source&&(setTextId("popup-website-url",a.pdfLink.replace(/^https?:\/\//,"")),showId("popup-website-url")),log("Popup paper:",a),setHTML("popup-memory-edit",getPopupEditFormHTML(a)),setHTML("popup-copy-icons",getPopupPaperIconsHTML(a,o,t)),setHTML("popup-title-tooltip",getPaperInfoTable(a)),findEl("checkFavorite--"+r).checked=a.favorite;let e=0;for(l of["checkScirate","checkVanity","checkAr5iv","checkHugginface"])i[l]&&(e+=5);style("popup-icons-container","width",75+e+"%"),$("#popup-item-tags--"+s).select2({...global.select2Options,width:"87%"}),addListener("popup-form-note-textarea--"+r,"focus",()=>{textareaFocusEnd(this)}),setFormChangeListener(r,!0),addListener("popup-delete-paper","click",handlePopupDeletePaper(r)),addListener("popup-paper-title","mouseenter",getHandleTitleTooltip(showTitleTooltip,1500,!0)),addListener("popup-paper-title","mouseleave",getHandleTitleTooltip(hideTitleTooltip,500,!0)),addListener("popup-memory-item-scirate--"+r,"click",()=>{var e=arxivIdFromPaperID(a.id);chrome.tabs.update({url:"https://scirate.com/arxiv/"+e}),window.close()}),addListener("popup-memory-item-vanity--"+r,"click",()=>{var e=arxivIdFromPaperID(a.id);chrome.tabs.update({url:"https://www.arxiv-vanity.com/papers/"+e}),window.close()}),addListener("popup-memory-item-ar5iv--"+r,"click",()=>{var e=arxivIdFromPaperID(a.id);chrome.tabs.update({url:"https://ar5iv.labs.arxiv.org/html/"+e}),window.close()}),addListener("popup-memory-item-huggingface--"+r,"click",()=>{var e=arxivIdFromPaperID(a.id);chrome.tabs.update({url:"https://huggingface.co/papers/"+e}),window.close()}),addListener("popup-memory-item-link--"+r,"click",()=>{var e=paperToPDF(a),t=paperToAbs(a);chrome.tabs.update({url:isPdfUrl(o)?t:e}),window.close()}),addListener("popup-code-link","click",async()=>{var e=findEl("popup-code-link").textContent;e&&(await focusExistingOrCreateNewCodeTab(e),global.close)&&global.close()}),addListener("popup-website-url","click",async e=>{var t=findEl("popup-website-url").textContent;t&&await focusExistingOrCreateNewCodeTab(t)}),addListener("popup-memory-item-copy-link--"+r,"click",async()=>{var e=(i.checkPreferPdf?paperToPDF:paperToAbs)(a),t=i.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem(r,e,t+" link copied!",!0)}),addListener("popup-memory-item-copy-hyperlink--"+r,"click",async()=>{var e=(i.checkPreferPdf?paperToPDF:paperToAbs)(a),t=i.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem(r,e,t+" hyperlink copied!",!0,a.title)}),addListener("popup-memory-item-md--"+r,"click",async()=>{var e=makeMdLink(a,i),t=i.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem(r,e,`Markdown link to ${t} copied!`,!0)}),addListener("popup-memory-item-bibtex--"+r,"click",async()=>{var e=global.state.papers[r].bibtex,t=bibtexToObject(e);t.hasOwnProperty("url")||(t.url=paperToAbs(global.state.papers[r])),t.hasOwnProperty("pdf")||(t.pdf=paperToPDF(global.state.papers[r])),e=bibtexToString(t),await copyAndConfirmMemoryItem(r,e,"Bibtex citation copied!",!0)}),addListener("popup-memory-item-openLocal--"+r,"click",async()=>{var e=await findLocalFile(a)||global.state.files[a.id];e?chrome.downloads.open(e.id):chrome.tabs.create({url:a.pdfLink})}),addListener("popup-memory-item-download--"+r,"click",async()=>{downloadPaperPdf(a)})}else log("Unknown id "+r),await updatePopupPaperNoMemory(o),i.checkDirectOpen&&!i.checkNoAuto&&dispatch("memory-switch","click")}else i.checkDirectOpen&&dispatch("memory-switch","click"),a&&global.state.prefs.checkWebsiteParsing&&(setHTML("webite-parsing-root",`
                <div id="website-trigger-wrapper">
                    <div id="website-trigger-btn">Parse current website</div>
                    <div id="website-loader-container" class="pm-container" style='display: none;'>
                        <div class="sk-folding-cube">
                            <div class="sk-cube1 sk-cube"></div>
                            <div class="sk-cube2 sk-cube"></div>
                            <div class="sk-cube4 sk-cube"></div>
                            <div class="sk-cube3 sk-cube"></div>
                        </div>
                    </div>
                    <div id="website-parsing-error"></div>
                </div>`),showId("webite-parsing-root"),addListener("website-trigger-btn","click",async()=>{hideId("website-trigger-btn"),showId("website-loader-container"),hideId("website-parsing-error");let e;try{e=await addOrUpdatePaper({tab:a,url:a.url,store:!1})}catch(e){console.log("error: ",e),hideId("website-loader-container"),showId("website-parsing-error"),setHTML("website-parsing-error",`<h3>Error</h3><div>${e}</div>`)}hideId("website-loader-container"),e?.paper&&editManualWebsite(e.paper,o)}))},query={active:!0,lastFocusedWindow:!0};window.location.href.includes("popup")&&chrome.tabs.query(query,async e=>{chrome.runtime.connect({name:"PaperMemoryPopupSync"});var t=e[0].url;let a,r;r=new Promise(t=>{a=new Promise(e=>{initSyncAndState({stateIsReady:e,remoteIsReady:t})})}),await a;var o=await isPaper(t);Object.values(o).some(e=>e)||showId("notArxiv"),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML(),popupMain(t,o,!1,e[0]),-1<navigator.userAgent.search("Firefox")&&hideId("overwrite-container"),await r,global.state.currentId&&!global.state.papers[global.state.currentId]&&(global.state.currentId=null,makeMemoryHTML(),await updatePopupPaperNoMemory(t))});